<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>All Orders - Order History</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, sans-serif; margin: 0; background-color: #f5f5f7; color: #1d1d1f; }
        .container { padding: 40px; }
        h1 { font-size: 2.5em; margin-bottom: 40px; }
        .stats-cards { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 40px; }
        .stat-card { background-color: #ffffff; border-radius: 12px; padding: 20px; text-align: center; box-shadow: 0 4px 12px rgba(0,0,0,0.08); }
        .stat-number { font-size: 2em; font-weight: bold; color: #007aff; }
        .stat-label { font-size: 0.9em; color: #666; margin-top: 5px; }
        .card { background-color: #ffffff; border-radius: 12px; padding: 20px; margin-bottom: 30px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); }
        h2 { font-size: 1.5em; border-bottom: 1px solid #e5e5e5; padding-bottom: 10px; margin-top: 0; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { text-align: left; padding: 12px; border-bottom: 1px solid #e5e5e5; }
        th { font-weight: 600; background-color: #f8f9fa; }
        .status-fulfilled { background-color: #d4edda; color: #155724; padding: 4px 8px; border-radius: 4px; font-size: 0.85em; }
        .status-pending { background-color: #fff3cd; color: #856404; padding: 4px 8px; border-radius: 4px; font-size: 0.85em; }
        a { color: #007aff; text-decoration: none; }
        .nav-link { display: inline-block; margin: 10px 20px 10px 0; }
        .order-details { cursor: pointer; }
        .order-details:hover { background-color: #f8f9fa; }
        .search-box { margin-bottom: 20px; padding: 10px; border: 1px solid #ddd; border-radius: 8px; width: 300px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Order History - All Orders</h1>

        <!-- Statistics Cards -->
        <div class="stats-cards">
            <div class="stat-card">
                <div class="stat-number" th:text="${#lists.size(allOrders)}">0</div>
                <div class="stat-label">Total Orders</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" th:text="${#lists.size(fulfilledOrders)}">0</div>
                <div class="stat-label">Fulfilled Orders</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" th:text="${#lists.size(pendingOrders)}">0</div>
                <div class="stat-label">Pending Orders</div>
            </div>
        </div>

        <!-- All Orders Table -->
        <div class="card">
            <h2>Complete Order History</h2>
            <input type="text" id="searchBox" class="search-box" placeholder="Search by customer name or order ID..." onkeyup="filterOrders()">
            <table id="ordersTable">
                <thead>
                    <tr>
                        <th>Order ID</th>
                        <th>Customer</th>
                        <th>Items</th>
                        <th>Total Amount</th>
                        <th>Discount</th>
                        <th>Order Date</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    <tr th:each="order : ${allOrders}" class="order-details">
                        <td>
                            <a th:href="@{'/admin/orders/' + ${order.id}}" style="font-weight: 600; color: #007aff;">
                                #<span th:text="${order.id}"></span>
                            </a>
                        </td>
                        <td>
                            <div th:text="${order.username}" style="font-weight: 500;"></div>
                            <small th:text="${order.customerEmail}" style="color: #666; font-size: 0.85em;"></small>
                        </td>
                        <td>
                            <div style="font-weight: 500;" th:text="${order.totalItems} + ' items'"></div>
                            <div style="font-size: 0.85em; color: #666; max-width: 200px; overflow: hidden; text-overflow: ellipsis;">
                                <span th:each="item, iterStat : ${order.orderItems}">
                                    <span th:text="${item.quantity + 'x ' + item.fruitName}"></span>
                                    <span th:if="${!iterStat.last}" th:text="', '"></span>
                                    <span th:if="${iterStat.index >= 2 && !iterStat.last}">...</span>
                                    <span th:if="${iterStat.index >= 2}" style="display: none;"></span>
                                </span>
                            </div>
                        </td>
                        <td>
                            <div th:if="${order.hasDiscount()}" style="text-decoration: line-through; color: #999; font-size: 0.85em;">
                                $<span th:text="${#numbers.formatDecimal(order.originalAmount, 1, 2)}"></span>
                            </div>
                            <div style="font-weight: 600;" th:text="${'$' + #numbers.formatDecimal(order.totalAmount, 1, 2)}"></div>
                        </td>
                        <td>
                            <div th:if="${order.hasDiscount()}" style="color: #28a745; font-size: 0.85em;">
                                <div th:text="${order.couponCode}"></div>
                                <div>-$<span th:text="${#numbers.formatDecimal(order.discountAmount, 1, 2)}"></span></div>
                            </div>
                            <div th:unless="${order.hasDiscount()}" style="color: #999; font-size: 0.85em;">
                                No discount
                            </div>
                        </td>
                        <td th:text="${#temporals.format(order.orderDate, 'MMM dd, yyyy HH:mm')}"></td>
                        <td>
                            <span th:if="${order.fulfilled}" class="status-fulfilled">Fulfilled</span>
                            <span th:unless="${order.fulfilled}" class="status-pending">Pending</span>
                            <div th:if="${order.fulfilled and order.fulfilledDate != null}" style="font-size: 0.75em; color: #666; margin-top: 2px;">
                                <span th:text="${#temporals.format(order.fulfilledDate, 'MMM dd HH:mm')}"></span>
                            </div>
                        </td>
                        <td>
                            <a th:href="@{'/admin/orders/' + ${order.id}}" 
                               style="background-color: #007aff; color: white; border: none; padding: 6px 12px; border-radius: 4px; text-decoration: none; font-size: 0.85em; margin-right: 5px;">
                                View Details
                            </a>
                            <button th:if="${!order.fulfilled}" 
                                    th:attr="onclick='fulfillOrder(\'' + ${order.id} + '\')'" 
                                    class="btn btn-success" 
                                    style="background-color: #28a745; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 0.85em;">
                                Fulfill
                            </button>
                            <span th:if="${order.fulfilled}" style="color: #28a745; font-weight: 500; font-size: 0.85em;">✓ Done</span>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- Navigation Links -->
        <a href="/admin" class="nav-link">← Back to Admin Panel</a>
        <a href="/admin/groceries" class="nav-link">Manage Groceries</a>
        <a href="/admin/orders/fulfilled" class="nav-link">View Only Fulfilled Orders</a>
    </div>

    <script>
        function filterOrders() {
            const searchBox = document.getElementById('searchBox');
            const filter = searchBox.value.toUpperCase();
            const table = document.getElementById('ordersTable');
            const rows = table.getElementsByTagName('tr');

            for (let i = 1; i < rows.length; i++) {
                const cells = rows[i].getElementsByTagName('td');
                let found = false;
                
                // Search in Order ID, Customer Name, and Email
                if (cells[0] && cells[0].textContent.toUpperCase().indexOf(filter) > -1) found = true;
                if (cells[1] && cells[1].textContent.toUpperCase().indexOf(filter) > -1) found = true;
                if (cells[2] && cells[2].textContent.toUpperCase().indexOf(filter) > -1) found = true;
                
                rows[i].style.display = found ? '' : 'none';
            }
        }

        function fulfillOrder(orderId) {
            if (confirm('Are you sure you want to mark this order as fulfilled?')) {
                fetch('/admin/orders/' + orderId + '/fulfill', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                })
                .then(response => {
                    if (response.ok) {
                        alert('Order marked as fulfilled successfully!');
                        location.reload(); // Refresh the page to update the status
                    } else {
                        alert('Failed to fulfill order.');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Failed to fulfill order.');
                });
            }
        }
    </script>
</body>
</html> 